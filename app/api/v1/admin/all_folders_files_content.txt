### Combined Content from Folder: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin ###



# ===== Folder: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin =====

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\assignments.py ---
from __future__ import annotations

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Path, status

from api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.admin.admin_hostel_assignment import (
    AdminHostelAssignment,
    AssignmentCreate,
    AssignmentUpdate,
    BulkAssignment,
    RevokeAssignment,
    AssignmentList,
    HostelAdminList,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import AdminHostelAssignmentService

router = APIRouter(prefix="/assignments")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


# -------- Admin → Hostels -------- #


@router.get(
    "/admins/{admin_id}",
    response_model=AssignmentList,
    summary="List hostel assignments for an admin",
)
async def list_admin_assignments(
    admin_id: UUID = Path(..., description="Admin ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> AssignmentList:
    """
    Return all hostel assignments for a given admin, including primary flags and permissions.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.list_assignments_for_admin(admin_id=admin_id)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/admins/{admin_id}",
    response_model=AdminHostelAssignment,
    status_code=status.HTTP_201_CREATED,
    summary="Assign an admin to a hostel",
)
async def create_admin_assignment(
    admin_id: UUID,
    payload: AssignmentCreate,
    uow: UnitOfWork = Depends(get_uow),
) -> AdminHostelAssignment:
    """
    Create a single admin↔hostel assignment.

    Enforces:
    - Uniqueness per (admin, hostel)
    - At most one primary hostel per admin
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.create_assignment(admin_id=admin_id, data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.patch(
    "/admins/{admin_id}/{assignment_id}",
    response_model=AdminHostelAssignment,
    summary="Update admin↔hostel assignment",
)
async def update_admin_assignment(
    admin_id: UUID,
    assignment_id: UUID,
    payload: AssignmentUpdate,
    uow: UnitOfWork = Depends(get_uow),
) -> AdminHostelAssignment:
    """
    Update assignment metadata (permissions, primary flag, etc.).
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.update_assignment(
            admin_id=admin_id,
            assignment_id=assignment_id,
            data=payload,
        )
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/admins/{admin_id}/bulk",
    response_model=List[AdminHostelAssignment],
    summary="Bulk assign admin to multiple hostels",
)
async def bulk_assign_admin(
    admin_id: UUID,
    payload: BulkAssignment,
    uow: UnitOfWork = Depends(get_uow),
) -> List[AdminHostelAssignment]:
    """
    Bulk-assign an admin to multiple hostels in one call.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.bulk_assign(admin_id=admin_id, data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/admins/{admin_id}/{assignment_id}/revoke",
    response_model=AdminHostelAssignment,
    summary="Revoke admin↔hostel assignment",
)
async def revoke_admin_assignment(
    admin_id: UUID,
    assignment_id: UUID,
    payload: RevokeAssignment,
    uow: UnitOfWork = Depends(get_uow),
) -> AdminHostelAssignment:
    """
    Revoke an assignment with a reason; typically marks it inactive and records revoked_date.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.revoke_assignment(
            admin_id=admin_id,
            assignment_id=assignment_id,
            data=payload,
        )
    except ServiceError as exc:
        raise _map_service_error(exc)


# -------- Hostel → Admins -------- #


@router.get(
    "/hostels/{hostel_id}",
    response_model=HostelAdminList,
    summary="List admins for a hostel",
)
async def list_hostel_admins(
    hostel_id: UUID = Path(..., description="Hostel ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> HostelAdminList:
    """
    List all admins assigned to a given hostel, with metadata.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.list_admins_for_hostel(hostel_id=hostel_id)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\dashboard.py ---
from __future__ import annotations

from datetime import date
from fastapi import APIRouter, Depends, HTTPException, Query, status

from api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.analytics.platform_analytics import (
    PlatformMetrics,
    GrowthMetrics,
    PlatformUsageAnalytics,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import SuperAdminDashboardService

router = APIRouter(prefix="/dashboard")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "/platform/metrics/latest",
    response_model=PlatformMetrics,
    summary="Get latest platform-wide metrics (super admin)",
)
async def get_latest_platform_metrics(
    uow: UnitOfWork = Depends(get_uow),
) -> PlatformMetrics:
    """
    Fetch the latest platform-level metrics snapshot.

    Backed by SuperAdminDashboardService.
    """
    service = SuperAdminDashboardService(uow)
    try:
        return service.get_latest_platform_metrics()
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/platform/growth",
    response_model=GrowthMetrics,
    summary="Get growth metrics for a period (super admin)",
)
async def get_growth_metrics(
    period_start: date = Query(..., description="Start date (inclusive)"),
    period_end: date = Query(..., description="End date (inclusive)"),
    uow: UnitOfWork = Depends(get_uow),
) -> GrowthMetrics:
    """
    Fetch growth metrics (hostels, revenue, users) for the given period.
    """
    service = SuperAdminDashboardService(uow)
    try:
        return service.get_growth_metrics(period_start=period_start, period_end=period_end)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/platform/usage/latest",
    response_model=PlatformUsageAnalytics,
    summary="Get latest platform usage analytics (super admin)",
)
async def get_latest_platform_usage(
    uow: UnitOfWork = Depends(get_uow),
) -> PlatformUsageAnalytics:
    """
    Fetch the latest API/platform usage analytics snapshot.
    """
    service = SuperAdminDashboardService(uow)
    try:
        return service.get_latest_platform_usage()
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\hostels.py ---
from __future__ import annotations

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Path, status

from api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.hostel.hostel_base import HostelCreate, HostelUpdate
from app.schemas.hostel.hostel_response import HostelResponse, HostelDetail
from app.schemas.hostel.hostel_filter import HostelFilterParams
from app.services.common.unit_of_work import UnitOfWork
from app.services.hostel import HostelService

router = APIRouter(prefix="/hostels")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "",
    response_model=List[HostelResponse],
    summary="List hostels (admin view)",
)
async def list_hostels(
    filters: HostelFilterParams = Depends(),
    uow: UnitOfWork = Depends(get_uow),
) -> List[HostelResponse]:
    """
    List hostels for admin users.

    Uses HostelService.list_hostels with HostelFilterParams.
    """
    service = HostelService(uow)
    try:
        return service.list_hostels(filters=filters)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "",
    response_model=HostelDetail,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new hostel",
)
async def create_hostel(
    payload: HostelCreate,
    uow: UnitOfWork = Depends(get_uow),
) -> HostelDetail:
    """
    Create a new hostel.

    Ensures slug uniqueness and applies default flags.
    """
    service = HostelService(uow)
    try:
        return service.create_hostel(data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/{hostel_id}",
    response_model=HostelDetail,
    summary="Get hostel details (admin)",
)
async def get_hostel(
    hostel_id: UUID = Path(..., description="Hostel ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> HostelDetail:
    """
    Retrieve detailed hostel information for admin users.
    """
    service = HostelService(uow)
    try:
        return service.get_hostel(hostel_id=hostel_id)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.patch(
    "/{hostel_id}",
    response_model=HostelDetail,
    summary="Update a hostel (admin)",
)
async def update_hostel(
    hostel_id: UUID = Path(..., description="Hostel ID"),
    payload: HostelUpdate = ...,
    uow: UnitOfWork = Depends(get_uow),
) -> HostelDetail:
    """
    Partially update hostel fields.

    Delegates to HostelService.update_hostel.
    """
    service = HostelService(uow)
    try:
        return service.update_hostel(hostel_id=hostel_id, data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\multi_hostel.py ---
from __future__ import annotations

from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Query, status

from api.deps import get_uow, get_current_active_user
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.models.core import User
from app.schemas.admin.multi_hostel_dashboard import MultiHostelDashboard
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import MultiHostelDashboardService

router = APIRouter(prefix="/multi-hostel")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "/dashboard",
    response_model=MultiHostelDashboard,
    summary="Get multi-hostel dashboard for an admin",
)
async def get_multi_hostel_dashboard(
    admin_id: Optional[UUID] = Query(
        None,
        description="Admin ID (optional; if omitted, resolved from current user)",
    ),
    current_user: User = Depends(get_current_active_user),
    uow: UnitOfWork = Depends(get_uow),
) -> MultiHostelDashboard:
    """
    Build a consolidated dashboard for an admin managing multiple hostels.

    If `admin_id` is not provided, it is derived from the current user's admin profile.
    """
    # Derive admin_id from current user if not explicitly provided
    if admin_id is None:
        admin_profile = getattr(current_user, "admin_profile", None)
        if admin_profile is None:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Current user is not an admin",
            )
        admin_id = admin_profile.id

    service = MultiHostelDashboardService(uow)
    try:
        return service.get_dashboard(admin_id=admin_id)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\overrides.py ---
from __future__ import annotations

from datetime import date
from typing import List, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Path, Query, status

from api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.admin.admin_override import (
    AdminOverrideRequest,
    OverrideLog,
    OverrideSummary,
    SupervisorOverrideStats,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import AdminOverrideService

router = APIRouter(prefix="/overrides")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.post(
    "",
    response_model=OverrideLog,
    status_code=status.HTTP_201_CREATED,
    summary="Create an admin override",
)
async def create_admin_override(
    payload: AdminOverrideRequest,
    uow: UnitOfWork = Depends(get_uow),
) -> OverrideLog:
    """
    Record an admin override of a supervisor decision.

    Also expected to create generic audit entries internally.
    """
    service = AdminOverrideService(uow)
    try:
        return service.create_override(request=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/entity/{entity_type}/{entity_id}",
    response_model=List[OverrideLog],
    summary="List overrides for a specific entity",
)
async def list_overrides_for_entity(
    entity_type: str = Path(..., description="Entity type (complaint, maintenance, leave, etc.)"),
    entity_id: UUID = Path(..., description="Entity ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> List[OverrideLog]:
    """
    Fetch all overrides applied to a particular entity.
    """
    service = AdminOverrideService(uow)
    try:
        return service.list_overrides_for_entity(entity_type=entity_type, entity_id=entity_id)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/summary",
    response_model=OverrideSummary,
    summary="Get override summary for a period",
)
async def get_override_summary(
    hostel_id: Optional[UUID] = Query(None, description="Filter by hostel"),
    supervisor_id: Optional[UUID] = Query(None, description="Filter by supervisor"),
    start_date: Optional[date] = Query(None, description="Start date (inclusive)"),
    end_date: Optional[date] = Query(None, description="End date (inclusive)"),
    uow: UnitOfWork = Depends(get_uow),
) -> OverrideSummary:
    """
    Summarize overrides over a period, optionally filtered by hostel/supervisor.
    """
    service = AdminOverrideService(uow)
    try:
        return service.get_override_summary(
            hostel_id=hostel_id,
            supervisor_id=supervisor_id,
            start_date=start_date,
            end_date=end_date,
        )
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/supervisors/{supervisor_id}/stats",
    response_model=SupervisorOverrideStats,
    summary="Get override stats for a supervisor",
)
async def get_supervisor_override_stats(
    supervisor_id: UUID = Path(..., description="Supervisor ID"),
    start_date: Optional[date] = Query(None),
    end_date: Optional[date] = Query(None),
    uow: UnitOfWork = Depends(get_uow),
) -> SupervisorOverrideStats:
    """
    Supervisor-specific override statistics (counts, types, trends).
    """
    service = AdminOverrideService(uow)
    try:
        return service.get_supervisor_override_stats(
            supervisor_id=supervisor_id,
            start_date=start_date,
            end_date=end_date,
        )
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\permissions.py ---
from __future__ import annotations

from fastapi import APIRouter, Depends, HTTPException, Path, status

from api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.admin.admin_permissions import (
    PermissionMatrix,
    RolePermissions,
    PermissionCheck,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import PermissionMatrixService

router = APIRouter(prefix="/permissions")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "/matrix",
    response_model=PermissionMatrix,
    summary="Get global role→permissions matrix",
)
async def get_permission_matrix(
    uow: UnitOfWork = Depends(get_uow),
) -> PermissionMatrix:
    """
    Fetch the current role→permissions matrix.

    Backed by PermissionMatrixService.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.get_matrix()
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.put(
    "/matrix",
    response_model=PermissionMatrix,
    summary="Update global role→permissions matrix",
)
async def update_permission_matrix(
    payload: PermissionMatrix,
    uow: UnitOfWork = Depends(get_uow),
) -> PermissionMatrix:
    """
    Replace the stored permission matrix.

    Should typically be restricted to super admins.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.update_matrix(matrix=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/roles/{role_name}",
    response_model=RolePermissions,
    summary="Get permissions for a specific role",
)
async def get_role_permissions(
    role_name: str = Path(..., description="Role name (e.g. HOSTEL_ADMIN)"),
    uow: UnitOfWork = Depends(get_uow),
) -> RolePermissions:
    """
    Fetch the permissions assigned to a specific role.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.get_role_permissions(role_name=role_name)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/check",
    response_model=PermissionCheck,
    summary="Check if a principal has a permission in a hostel",
)
async def check_permission(
    payload: PermissionCheck,
    uow: UnitOfWork = Depends(get_uow),
) -> PermissionCheck:
    """
    Check a single permission for a principal in the context of a hostel.

    Uses PermissionMatrixService.check_permission which bridges into RBACService.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.check_permission(check=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\__init__.py ---
from __future__ import annotations

from fastapi import APIRouter

from . import dashboard
from . import hostels
from . import assignments
from . import permissions
from . import overrides
from . import multi_hostel

router = APIRouter(prefix="/admin")

router.include_router(dashboard.router, tags=["Admin - Dashboard"])
router.include_router(hostels.router, tags=["Admin - Hostels"])
router.include_router(assignments.router, tags=["Admin - Assignments"])
router.include_router(permissions.router, tags=["Admin - Permissions"])
router.include_router(overrides.router, tags=["Admin - Overrides"])
router.include_router(multi_hostel.router, tags=["Admin - Multi-Hostel"])

__all__ = ["router"]
