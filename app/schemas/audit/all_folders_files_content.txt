### Combined Content from Folder: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit ###



# ===== Folder: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit =====

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\admin_override_log.py ---
"""
Admin override audit log schemas
"""
from datetime import datetime
from typing import Any, Dict, List, Optional
from pydantic import Field
from uuid import UUID

from app.schemas.common.base import BaseSchema, BaseCreateSchema, BaseResponseSchema


class AdminOverrideBase(BaseSchema):
    """
    Base admin override log fields.

    Mirrors `admin_override_logs` table:
    - admin_id
    - supervisor_id (optional)
    - hostel_id
    - override_type
    - entity_type
    - entity_id
    - reason
    - original_action
    - override_action
    - created_at
    """
    admin_id: UUID = Field(..., description="Admin who performed the override")
    supervisor_id: Optional[UUID] = Field(
        None,
        description="Supervisor whose decision was overridden (if applicable)",
    )
    hostel_id: UUID = Field(..., description="Hostel where the override occurred")

    override_type: str = Field(
        ...,
        max_length=100,
        description="Type of override, e.g. 'complaint_reassignment', 'maintenance_approval'",
    )

    entity_type: str = Field(
        ...,
        max_length=50,
        description="Entity type affected, e.g. 'complaint', 'maintenance_request'",
    )
    entity_id: UUID = Field(..., description="Primary key of affected entity")

    reason: str = Field(
        ...,
        min_length=10,
        max_length=2000,
        description="Why the admin override was performed",
    )

    original_action: Optional[Dict[str, Any]] = Field(
        None,
        description="Snapshot of supervisor's original action/decision",
    )
    override_action: Dict[str, Any] = Field(
        ...,
        description="Admin's override decision, details",
    )

    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        description="Timestamp when override was recorded",
    )


class AdminOverrideCreate(AdminOverrideBase, BaseCreateSchema):
    """Payload used by services to record a new admin override."""
    pass


class AdminOverrideLogResponse(BaseResponseSchema):
    """
    List item representation of an admin override log.
    Useful for audit tables, supervisor performance review, etc.
    """
    admin_id: UUID
    admin_name: Optional[str] = Field(None, description="Admin display name")

    supervisor_id: Optional[UUID]
    supervisor_name: Optional[str] = Field(None, description="Supervisor display name")

    hostel_id: UUID
    hostel_name: Optional[str] = None

    override_type: str
    entity_type: str
    entity_id: UUID

    reason: str

    created_at: datetime


class AdminOverrideDetail(BaseResponseSchema):
    """
    Detailed view of a single admin override entry,
    including original and override actions.
    """
    admin_id: UUID
    admin_name: Optional[str] = None

    supervisor_id: Optional[UUID]
    supervisor_name: Optional[str] = None

    hostel_id: UUID
    hostel_name: Optional[str] = None

    override_type: str
    entity_type: str
    entity_id: UUID

    reason: str

    original_action: Optional[Dict[str, Any]]
    override_action: Dict[str, Any]

    created_at: datetime


class AdminOverrideSummary(BaseSchema):
    """
    Summary statistics for admin overrides,
    typically for supervisor performance/oversight dashboards.
    """
    period_start: datetime
    period_end: datetime

    # Scope
    supervisor_id: Optional[UUID] = Field(
        None, description="If summarizing overrides for specific supervisor"
    )
    hostel_id: Optional[UUID] = Field(
        None, description="If summarizing for specific hostel"
    )

    # Overall stats
    total_overrides: int = Field(..., ge=0)
    overrides_by_type: Dict[str, int] = Field(
        default_factory=dict,
        description="override_type -> count",
    )
    overrides_by_admin: Dict[UUID, int] = Field(
        default_factory=dict,
        description="admin_id -> count",
    )

    # For supervisor perspective
    override_rate_for_supervisor: Optional[float] = Field(
        None,
        description="For a given supervisor: overridden_actions / total_actions",
    )


class AdminOverrideTimelinePoint(BaseSchema):
    """Time-bucketed view of overrides (e.g., by day/week)."""
    bucket_label: str = Field(..., description="e.g. '2025-01-10' or 'Week 02'")
    override_count: int = Field(..., ge=0)

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\audit_filters.py ---
"""
Audit log filtering schemas
"""
from datetime import datetime
from typing import List, Optional
from pydantic import Field
from uuid import UUID

from app.schemas.common.base import BaseFilterSchema
from app.schemas.common.enums import AuditActionCategory, UserRole
from app.schemas.common.filters import DateTimeRangeFilter


class AuditFilterParams(BaseFilterSchema):
    """Filter criteria for querying audit logs"""
    # Actor
    user_id: Optional[UUID] = None
    user_role: Optional[UserRole] = None

    # Hostel
    hostel_id: Optional[UUID] = None

    # Entity
    entity_type: Optional[str] = Field(None, max_length=50)
    entity_id: Optional[UUID] = None

    # Action
    action_type: Optional[str] = Field(None, max_length=100)
    action_category: Optional[AuditActionCategory] = None

    # Time range
    datetime_range: Optional[DateTimeRangeFilter] = None

    # Request ID
    request_id: Optional[str] = None

    # Paging
    page: int = Field(1, ge=1)
    page_size: int = Field(50, ge=1, le=200)

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\audit_log_base.py ---
"""
Base schemas for audit log entries
"""
from datetime import datetime
from typing import Optional, Dict, Any
from pydantic import Field
from uuid import UUID

from app.schemas.common.base import BaseSchema, BaseCreateSchema
from app.schemas.common.enums import AuditActionCategory, UserRole


class AuditLogBase(BaseSchema):
    """Base audit log entry schema (read model)"""
    user_id: Optional[UUID] = Field(None, description="Actor user ID (if any)")
    user_role: Optional[UserRole] = Field(None, description="Actor role (if known)")

    action_type: str = Field(..., max_length=100, description="Action type identifier")
    action_category: AuditActionCategory = Field(
        AuditActionCategory.OTHER, description="High-level action category"
    )

    entity_type: Optional[str] = Field(
        None, max_length=50, description="Entity type name (e.g. 'Booking', 'Payment')"
    )
    entity_id: Optional[UUID] = Field(None, description="Primary key of affected entity")

    hostel_id: Optional[UUID] = Field(
        None, description="Hostel context (if applicable)"
    )

    description: str = Field(
        ..., max_length=2000, description="Human-readable description of action"
    )

    old_values: Optional[Dict[str, Any]] = Field(
        None, description="Previous values (for update actions)"
    )
    new_values: Optional[Dict[str, Any]] = Field(
        None, description="New values (for update actions)"
    )

    ip_address: Optional[str] = Field(None, description="IP address (if web/API call)")
    user_agent: Optional[str] = Field(None, description="User-Agent string")
    request_id: Optional[str] = Field(
        None, max_length=100, description="Correlation/request ID (for tracing)"
    )

    created_at: datetime = Field(default_factory=datetime.utcnow)


class AuditLogCreate(AuditLogBase, BaseCreateSchema):
    """Payload used by services to create a new audit log entry"""
    pass

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\audit_log_response.py ---
"""
Audit log response schemas
"""
from typing import Optional, Dict, Any
from pydantic import Field
from uuid import UUID

from app.schemas.common.base import BaseResponseSchema
from app.schemas.common.enums import AuditActionCategory, UserRole


class AuditLogResponse(BaseResponseSchema):
    """Audit log list item"""
    user_id: Optional[UUID]
    user_role: Optional[UserRole]

    action_type: str
    action_category: AuditActionCategory

    entity_type: Optional[str]
    entity_id: Optional[UUID]
    hostel_id: Optional[UUID]

    description: str

    ip_address: Optional[str]
    created_at: datetime


class AuditLogDetail(BaseResponseSchema):
    """Detailed audit log with old/new values"""
    user_id: Optional[UUID]
    user_role: Optional[UserRole]

    action_type: str
    action_category: AuditActionCategory

    entity_type: Optional[str]
    entity_id: Optional[UUID]
    hostel_id: Optional[UUID]

    description: str

    old_values: Optional[Dict[str, Any]]
    new_values: Optional[Dict[str, Any]]

    ip_address: Optional[str]
    user_agent: Optional[str]
    request_id: Optional[str]

    created_at: datetime

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\audit_reports.py ---
"""
Audit reporting schemas
"""
from datetime import datetime, date
from typing import List, Dict, Optional
from pydantic import Field
from uuid import UUID

from app.schemas.common.base import BaseSchema
from app.schemas.common.enums import AuditActionCategory, UserRole
from app.schemas.common.filters import DateRangeFilter


class AuditSummary(BaseSchema):
    """High-level summary for audit log report"""
    period: DateRangeFilter
    total_events: int

    # Distribution
    events_by_category: Dict[AuditActionCategory, int] = Field(default_factory=dict)
    events_by_user_role: Dict[UserRole, int] = Field(default_factory=dict)

    # Top actors
    top_users_by_events: List["UserActivitySummary"] = Field(default_factory=list)


class UserActivitySummary(BaseSchema):
    """Aggregate audit activity for one user"""
    user_id: UUID
    user_name: Optional[str] = None
    user_role: Optional[UserRole] = None

    total_events: int
    events_by_category: Dict[AuditActionCategory, int] = Field(default_factory=dict)


class EntityChangeSummary(BaseSchema):
    """Summary of changes for one entity type"""
    entity_type: str
    change_count: int
    last_change_at: datetime


class EntityChangeRecord(BaseSchema):
    """Single change record for history view"""
    log_id: UUID
    action_type: str
    description: str
    old_values: Optional[dict]
    new_values: Optional[dict]
    changed_by: Optional[UUID]
    changed_by_name: Optional[str]
    changed_at: datetime


class EntityChangeHistory(BaseSchema):
    """Complete change history for a specific entity instance"""
    entity_type: str
    entity_id: UUID
    changes: List[EntityChangeRecord] = Field(default_factory=list)


class AuditReport(BaseSchema):
    """Full audit report response"""
    generated_at: datetime = Field(default_factory=datetime.utcnow)
    period: DateRangeFilter

    summary: AuditSummary
    entity_summaries: List[EntityChangeSummary] = Field(default_factory=list)

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\supervisor_activity_log.py ---
"""
Supervisor activity audit log schemas
"""
from datetime import datetime
from typing import Any, Dict, List, Optional

from pydantic import Field
from uuid import UUID

from app.schemas.common.base import BaseSchema, BaseCreateSchema, BaseResponseSchema
from app.schemas.common.filters import DateTimeRangeFilter


class SupervisorActivityBase(BaseSchema):
    """
    Base fields for supervisor activity log.

    Mirrors the `supervisor_activity_logs` table:
    - supervisor_id
    - hostel_id
    - action_type
    - action_category
    - entity_type / entity_id
    - action_description
    - metadata
    - ip_address
    - user_agent
    - created_at
    """
    supervisor_id: UUID = Field(..., description="Supervisor performing the action")
    hostel_id: UUID = Field(..., description="Hostel where action occurred")

    action_type: str = Field(
        ...,
        max_length=100,
        description="Action identifier, e.g. 'complaint_resolved', 'attendance_marked'",
    )
    action_category: str = Field(
        ...,
        pattern=(
            r"^(complaint|attendance|maintenance|menu|announcement|"
            r"student_management|other)$"
        ),
        description="High-level category of action",
    )

    entity_type: Optional[str] = Field(
        None, max_length=50, description="Entity type, e.g. 'complaint', 'attendance'"
    )
    entity_id: Optional[UUID] = Field(
        None, description="ID of the entity affected (if applicable)"
    )

    action_description: str = Field(
        ...,
        max_length=2000,
        description="Human-readable description of the action",
    )

    metadata: Dict[str, Any] = Field(
        default_factory=dict,
        description="Extra details/context for the action (JSON)",
    )

    ip_address: Optional[str] = Field(
        None,
        description="IP address from which the action originated (if tracked)",
    )
    user_agent: Optional[str] = Field(
        None,
        description="User-Agent string from supervisor's device (if tracked)",
    )

    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        description="Timestamp when the action was logged",
    )


class SupervisorActivityCreate(SupervisorActivityBase, BaseCreateSchema):
    """Used by services to record a new supervisor activity log entry."""
    pass


class SupervisorActivityLogResponse(BaseResponseSchema):
    """
    List item representation of supervisor activity log.
    Suitable for tables or basic activity feeds.
    """
    supervisor_id: UUID
    supervisor_name: Optional[str] = Field(
        None, description="Supervisor display name (if joined in query)"
    )
    hostel_id: UUID
    hostel_name: Optional[str] = Field(
        None, description="Hostel display name (if joined in query)"
    )

    action_type: str
    action_category: str

    entity_type: Optional[str]
    entity_id: Optional[UUID]

    action_description: str

    created_at: datetime
    ip_address: Optional[str]
    user_agent: Optional[str]


class SupervisorActivityDetail(BaseResponseSchema):
    """
    Detailed view of a single supervisor activity entry,
    including full metadata.
    """
    supervisor_id: UUID
    supervisor_name: Optional[str] = None
    hostel_id: UUID
    hostel_name: Optional[str] = None

    action_type: str
    action_category: str

    entity_type: Optional[str]
    entity_id: Optional[UUID]

    action_description: str
    metadata: Dict[str, Any]

    ip_address: Optional[str]
    user_agent: Optional[str]
    created_at: datetime


class SupervisorActivityFilter(BaseSchema):
    """
    Filter criteria for querying supervisor activity logs.
    Typically used as a body/query schema for list endpoints.
    """
    supervisor_id: Optional[UUID] = None
    hostel_id: Optional[UUID] = None

    action_type: Optional[str] = Field(None, max_length=100)
    action_category: Optional[str] = Field(
        None,
        pattern=(
            r"^(complaint|attendance|maintenance|menu|announcement|"
            r"student_management|other)$"
        ),
    )

    entity_type: Optional[str] = Field(None, max_length=50)
    entity_id: Optional[UUID] = None

    datetime_range: Optional[DateTimeRangeFilter] = None

    # Pagination
    page: int = Field(1, ge=1)
    page_size: int = Field(50, ge=1, le=200)


class SupervisorActivitySummary(BaseSchema):
    """
    Summary statistics for a supervisor's activity over a period.
    Useful for performance dashboards.
    """
    supervisor_id: UUID
    supervisor_name: Optional[str] = None
    hostel_id: UUID
    hostel_name: Optional[str] = None

    period_start: datetime
    period_end: datetime

    total_actions: int
    actions_by_category: Dict[str, int] = Field(
        default_factory=dict,
        description="Category -> count",
    )
    actions_by_type: Dict[str, int] = Field(
        default_factory=dict,
        description="Action type -> count",
    )

    # For trending / charts (optional)
    timeline: List["SupervisorActivityTimelinePoint"] = Field(
        default_factory=list,
        description="Activity over time",
    )


class SupervisorActivityTimelinePoint(BaseSchema):
    """Time-bucketed count of supervisor actions (e.g., daily/weekly)."""
    bucket_label: str = Field(
        ...,
        description="Label for the time bucket (e.g. '2025-01-15', 'Week 12')",
    )
    action_count: int = Field(..., ge=0)

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\hostel-back\app\schemas\audit\__init__.py ---
"""
Audit & logging schemas package
"""

from app.schemas.audit.audit_log_base import (
    AuditLogBase,
    AuditLogCreate,
)
from app.schemas.audit.audit_log_response import (
    AuditLogResponse,
    AuditLogDetail,
)
from app.schemas.audit.audit_filters import (
    AuditFilterParams,
)
from app.schemas.audit.audit_reports import (
    AuditReport,
    AuditSummary,
    UserActivitySummary,
    EntityChangeHistory,
)
from app.schemas.audit.supervisor_activity_log import (
    SupervisorActivityBase,
    SupervisorActivityCreate,
    SupervisorActivityLogResponse,
    SupervisorActivityDetail,
    SupervisorActivityFilter,
    SupervisorActivitySummary,
    SupervisorActivityTimelinePoint,
)

from app.schemas.audit.admin_override_log import (
    AdminOverrideBase,
    AdminOverrideCreate,
    AdminOverrideLogResponse,
    AdminOverrideDetail,
    AdminOverrideSummary,
    AdminOverrideTimelinePoint,
)

__all__ = [
    # Base
    "AuditLogBase",
    "AuditLogCreate",
    # Response
    "AuditLogResponse",
    "AuditLogDetail",
    # Filters
    "AuditFilterParams",
    # Reports
    "AuditReport",
    "AuditSummary",
    "UserActivitySummary",
    "EntityChangeHistory",
    # Supervisor Activity
    "SupervisorActivityBase",
    "SupervisorActivityCreate",
    "SupervisorActivityLogResponse",
    "SupervisorActivityDetail",
    "SupervisorActivityFilter",
    "SupervisorActivitySummary",
    "SupervisorActivityTimelinePoint",
    # Admin Override
    "AdminOverrideBase",
    "AdminOverrideCreate",
    "AdminOverrideLogResponse",
    "AdminOverrideDetail",
    "AdminOverrideSummary",
    "AdminOverrideTimelinePoint",
]
