### Combined Content from Folder: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance ###



# ===== Folder: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance =====

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance\attendance_alert_service.py ---
# app/services/attendance/attendance_alert_service.py
from __future__ import annotations

from datetime import date, datetime, timezone
from typing import Callable, Dict, List, Optional, Protocol
from uuid import UUID, uuid4

from sqlalchemy.orm import Session

from app.repositories.core import StudentRepository, HostelRepository
from app.schemas.attendance.attendance_alert import (
    AttendanceAlert,
    AlertConfig,
    AlertTrigger,
    AlertAcknowledgment,
    AlertList,
    AlertSummary,
)
from app.services.common import UnitOfWork, errors


class AlertStore(Protocol):
    """
    Abstract store for attendance alerts and alert configuration.
    """

    def create_alert(self, record: dict) -> dict: ...
    def update_alert(self, alert_id: UUID, data: dict) -> dict: ...
    def get_alert(self, alert_id: UUID) -> Optional[dict]: ...
    def list_alerts_for_hostel(self, hostel_id: UUID) -> List[dict]: ...

    def get_config(self, hostel_id: UUID) -> Optional[dict]: ...
    def save_config(self, hostel_id: UUID, data: dict) -> None: ...


class AttendanceAlertService:
    """
    Attendance alert service:

    - Manage AlertConfig per hostel
    - Trigger manual alerts
    - Acknowledge alerts
    - List alerts and build summary
    """

    def __init__(
        self,
        session_factory: Callable[[], Session],
        store: AlertStore,
    ) -> None:
        self._session_factory = session_factory
        self._store = store

    def _get_hostel_repo(self, uow: UnitOfWork) -> HostelRepository:
        return uow.get_repo(HostelRepository)

    def _get_student_repo(self, uow: UnitOfWork) -> StudentRepository:
        return uow.get_repo(StudentRepository)

    def _now(self) -> datetime:
        return datetime.now(timezone.utc)

    # ------------------------------------------------------------------ #
    # Config
    # ------------------------------------------------------------------ #
    def get_config(self, hostel_id: UUID) -> AlertConfig:
        record = self._store.get_config(hostel_id)
        if record:
            return AlertConfig.model_validate(record)
        # Default config if none stored
        cfg = AlertConfig(
            hostel_id=hostel_id,
        )
        self._store.save_config(hostel_id, cfg.model_dump())
        return cfg

    def set_config(self, cfg: AlertConfig) -> None:
        self._store.save_config(cfg.hostel_id, cfg.model_dump())

    # ------------------------------------------------------------------ #
    # Alerts
    # ------------------------------------------------------------------ #
    def trigger_manual_alert(
        self,
        hostel_id: UUID,
        data: AlertTrigger,
    ) -> AttendanceAlert:
        """
        Manually trigger an alert for a student.
        """
        now = self._now()

        with UnitOfWork(self._session_factory) as uow:
            hostel_repo = self._get_hostel_repo(uow)
            student_repo = self._get_student_repo(uow)

            hostel = hostel_repo.get(hostel_id)
            if hostel is None:
                raise errors.NotFoundError(f"Hostel {hostel_id} not found")

            student = student_repo.get(data.student_id)
            if student is None or not getattr(student, "user", None):
                raise errors.NotFoundError(f"Student {data.student_id} not found")

            student_name = student.user.full_name

        alert_id = uuid4()
        record = {
            "id": alert_id,
            "alert_id": alert_id,
            "hostel_id": hostel_id,
            "student_id": data.student_id,
            "student_name": student_name,
            "alert_type": data.alert_type,
            "severity": data.severity,
            "message": data.custom_message,
            "details": {},
            "triggered_at": now,
            "triggered_by_rule": None,
            "acknowledged": False,
            "acknowledged_by": None,
            "acknowledged_at": None,
            "actions_taken": [],
            "resolved": False,
            "resolved_at": None,
            "created_at": now,
            "updated_at": now,
        }
        created = self._store.create_alert(record)
        return AttendanceAlert.model_validate(created)

    def acknowledge_alert(self, data: AlertAcknowledgment) -> AttendanceAlert:
        """
        Acknowledge an alert and record the action taken.
        """
        now = self._now()
        record = self._store.get_alert(data.alert_id)
        if not record:
            raise errors.NotFoundError(f"Alert {data.alert_id} not found")

        record["acknowledged"] = True
        record["acknowledged_by"] = str(data.acknowledged_by)
        record["acknowledged_at"] = now
        actions = record.get("actions_taken", []) or []
        actions.append(data.action_taken)
        record["actions_taken"] = actions
        record["updated_at"] = now

        updated = self._store.update_alert(data.alert_id, record)
        return AttendanceAlert.model_validate(updated)

    def list_alerts_for_hostel(self, hostel_id: UUID) -> AlertList:
        records = self._store.list_alerts_for_hostel(hostel_id)
        alerts: List[AttendanceAlert] = [
            AttendanceAlert.model_validate(r) for r in records
        ]

        total_alerts = len(alerts)
        unack = sum(1 for a in alerts if not a.acknowledged)
        critical = sum(1 for a in alerts if a.severity == "critical")

        return AlertList(
            hostel_id=hostel_id,
            total_alerts=total_alerts,
            unacknowledged_alerts=unack,
            critical_alerts=critical,
            alerts=alerts,
        )

    def get_alert_summary(
        self,
        hostel_id: UUID,
        *,
        period_start: date,
        period_end: date,
    ) -> AlertSummary:
        records = self._store.list_alerts_for_hostel(hostel_id)
        filtered: List[dict] = []
        for r in records:
            ta: datetime = r.get("triggered_at")
            if not isinstance(ta, datetime):
                continue
            d = ta.date()
            if d < period_start or d > period_end:
                continue
            filtered.append(r)

        total_alerts = len(filtered)

        low_att = cons_abs = late_ent = pattern = 0
        crit = high = med = low_s = 0
        acknowledged = resolved = 0

        for r in filtered:
            atype = r.get("alert_type")
            sev = r.get("severity")

            if atype == "low_attendance":
                low_att += 1
            elif atype == "consecutive_absences":
                cons_abs += 1
            elif atype == "late_entry":
                late_ent += 1
            elif atype == "irregular_pattern":
                pattern += 1

            if sev == "critical":
                crit += 1
            elif sev == "high":
                high += 1
            elif sev == "medium":
                med += 1
            elif sev == "low":
                low_s += 1

            if r.get("acknowledged"):
                acknowledged += 1
            if r.get("resolved"):
                resolved += 1

        pending = total_alerts - resolved

        return AlertSummary(
            hostel_id=hostel_id,
            period_start=period_start,
            period_end=period_end,
            total_alerts=total_alerts,
            low_attendance_alerts=low_att,
            consecutive_absence_alerts=cons_abs,
            late_entry_alerts=late_ent,
            pattern_alerts=pattern,
            critical_count=crit,
            high_count=high,
            medium_count=med,
            low_count=low_s,
            acknowledged_count=acknowledged,
            resolved_count=resolved,
            pending_count=pending,
        )

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance\attendance_policy_service.py ---
# app/services/attendance/attendance_policy_service.py
from __future__ import annotations

from datetime import date, datetime
from decimal import Decimal
from typing import Callable, List, Optional, Protocol
from uuid import UUID, uuid4

from sqlalchemy.orm import Session

from app.repositories.core import HostelRepository, StudentRepository
from app.schemas.attendance.attendance_policy import (
    AttendancePolicy,
    PolicyConfig,
    PolicyUpdate,
    PolicyViolation,
)
from app.schemas.common.filters import DateRangeFilter
from app.services.analytics import AttendanceAnalyticsService
from app.services.common import UnitOfWork, errors


class PolicyStore(Protocol):
    """
    Abstract storage for attendance policy per hostel.
    """

    def get_policy(self, hostel_id: UUID) -> Optional[dict]: ...
    def save_policy(self, hostel_id: UUID, data: dict) -> None: ...


class AttendancePolicyService:
    """
    Attendance policy management:

    - Get/update AttendancePolicy for a hostel
    - Evaluate simple policy violations for a student over a period
    """

    def __init__(
        self,
        session_factory: Callable[[], Session],
        store: PolicyStore,
    ) -> None:
        self._session_factory = session_factory
        self._store = store
        self._analytics = AttendanceAnalyticsService(session_factory)

    def _get_hostel_repo(self, uow: UnitOfWork) -> HostelRepository:
        return uow.get_repo(HostelRepository)

    def _get_student_repo(self, uow: UnitOfWork) -> StudentRepository:
        return uow.get_repo(StudentRepository)

    def _now(self) -> datetime:
        return datetime.utcnow()

    # ------------------------------------------------------------------ #
    # Policy CRUD
    # ------------------------------------------------------------------ #
    def get_policy(self, hostel_id: UUID) -> AttendancePolicy:
        """
        Fetch policy for a hostel, creating a default if none exists.
        """
        record = self._store.get_policy(hostel_id)
        if record:
            return AttendancePolicy.model_validate(record)

        with UnitOfWork(self._session_factory) as uow:
            hostel_repo = self._get_hostel_repo(uow)
            hostel = hostel_repo.get(hostel_id)
            if hostel is None:
                raise errors.NotFoundError(f"Hostel {hostel_id} not found")
            hostel_name = hostel.name

        now = self._now()
        policy = AttendancePolicy(
            id=uuid4(),
            created_at=now,
            updated_at=now,
            hostel_id=hostel_id,
            hostel_name=hostel_name,
            minimum_attendance_percentage=Decimal("75.0"),
            late_entry_threshold_minutes=15,
            grace_days_per_month=3,
            consecutive_absence_alert_days=3,
            notify_guardian_on_absence=True,
            notify_admin_on_low_attendance=True,
            low_attendance_threshold=Decimal("75.0"),
            auto_mark_absent_after_time=None,
            is_active=True,
        )
        self._store.save_policy(hostel_id, policy.model_dump())
        return policy

    def update_policy(self, hostel_id: UUID, data: PolicyUpdate) -> AttendancePolicy:
        """
        Update fields on AttendancePolicy.
        """
        policy = self.get_policy(hostel_id)
        mapping = data.model_dump(exclude_unset=True)
        for field, value in mapping.items():
            if hasattr(policy, field):
                setattr(policy, field, value)
        policy.updated_at = self._now()
        self._store.save_policy(hostel_id, policy.model_dump())
        return policy

    # ------------------------------------------------------------------ #
    # Violations
    # ------------------------------------------------------------------ #
    def evaluate_violations_for_student(
        self,
        hostel_id: UUID,
        student_id: UUID,
        period: DateRangeFilter,
    ) -> List[PolicyViolation]:
        """
        Evaluate basic policy violations:

        - low_attendance
        - consecutive_absences
        - excessive_late_entries
        """
        if not (period.start_date and period.end_date):
            raise errors.ValidationError(
                "Both start_date and end_date are required to evaluate violations"
            )

        policy = self.get_policy(hostel_id)

        with UnitOfWork(self._session_factory) as uow:
            hostel_repo = self._get_hostel_repo(uow)
            student_repo = self._get_student_repo(uow)

            hostel = hostel_repo.get(hostel_id)
            if hostel is None:
                raise errors.NotFoundError(f"Hostel {hostel_id} not found")

            student = student_repo.get(student_id)
            if student is None or not getattr(student, "user", None):
                raise errors.NotFoundError(f"Student {student_id} not found")
            student_name = student.user.full_name

        # Use analytics service for detailed record
        report = self._analytics.get_student_report(student_id, period)
        summary = report.summary
        daily_records = report.daily_records

        violations: List[PolicyViolation] = []
        violation_date = period.end_date

        # Low attendance
        if summary.attendance_percentage < policy.minimum_attendance_percentage:
            violations.append(
                PolicyViolation(
                    student_id=student_id,
                    student_name=student_name,
                    hostel_id=hostel_id,
                    violation_type="low_attendance",
                    current_attendance_percentage=summary.attendance_percentage,
                    consecutive_absences=None,
                    late_entries_this_month=None,
                    violation_date=violation_date,
                    guardian_notified=False,
                    admin_notified=False,
                    warning_issued=False,
                    notes=None,
                )
            )

        # Consecutive absences
        max_streak = 0
        current = 0
        for rec in sorted(daily_records, key=lambda r: r.date):
            status_str = (rec.status or "").upper()
            if status_str == AttendanceStatus.ABSENT.value:
                current += 1
                if current > max_streak:
                    max_streak = current
            else:
                current = 0

        if max_streak >= policy.consecutive_absence_alert_days:
            violations.append(
                PolicyViolation(
                    student_id=student_id,
                    student_name=student_name,
                    hostel_id=hostel_id,
                    violation_type="consecutive_absences",
                    current_attendance_percentage=summary.attendance_percentage,
                    consecutive_absences=max_streak,
                    late_entries_this_month=None,
                    violation_date=violation_date,
                    guardian_notified=False,
                    admin_notified=False,
                    warning_issued=False,
                    notes=None,
                )
            )

        # Excessive late entries (beyond grace days)
        late_days = summary.total_late
        if late_days > policy.grace_days_per_month:
            violations.append(
                PolicyViolation(
                    student_id=student_id,
                    student_name=student_name,
                    hostel_id=hostel_id,
                    violation_type="excessive_late_entries",
                    current_attendance_percentage=summary.attendance_percentage,
                    consecutive_absences=None,
                    late_entries_this_month=late_days,
                    violation_date=violation_date,
                    guardian_notified=False,
                    admin_notified=False,
                    warning_issued=False,
                    notes=None,
                )
            )

        return violations

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance\attendance_report_service.py ---
# app/services/attendance/attendance_report_service.py
from __future__ import annotations

from calendar import monthrange
from datetime import date, datetime
from decimal import Decimal
from typing import Callable, List
from uuid import UUID

from sqlalchemy.orm import Session

from app.repositories.core import HostelRepository, StudentRepository, RoomRepository
from app.schemas.attendance.attendance_report import (
    AttendanceReport,
    MonthlyReport,
    StudentMonthlySummary,
)
from app.schemas.common.filters import DateRangeFilter
from app.services.analytics import AttendanceAnalyticsService
from app.services.common import UnitOfWork, errors


class AttendanceReportService:
    """
    Higher-level attendance reporting facade:

    - Student-level report (delegates to AttendanceAnalyticsService)
    - Monthly hostel report (StudentMonthlySummary)
    """

    def __init__(self, session_factory: Callable[[], Session]) -> None:
        self._session_factory = session_factory
        self._analytics = AttendanceAnalyticsService(session_factory)

    def _get_hostel_repo(self, uow: UnitOfWork) -> HostelRepository:
        return uow.get_repo(HostelRepository)

    def _get_student_repo(self, uow: UnitOfWork) -> StudentRepository:
        return uow.get_repo(StudentRepository)

    def _get_room_repo(self, uow: UnitOfWork) -> RoomRepository:
        return uow.get_repo(RoomRepository)

    # ------------------------------------------------------------------ #
    # Student report
    # ------------------------------------------------------------------ #
    def get_student_report(
        self,
        student_id: UUID,
        period: DateRangeFilter,
    ) -> AttendanceReport:
        return self._analytics.get_student_report(student_id, period)

    # ------------------------------------------------------------------ #
    # Monthly hostel report
    # ------------------------------------------------------------------ #
    def get_monthly_report(self, hostel_id: UUID, month: str) -> MonthlyReport:
        """
        Build a MonthlyReport (per-hostel) for given YYYY-MM.

        Uses AttendanceAnalyticsService per student under that hostel.
        """
        try:
            year, m = map(int, month.split("-"))
        except ValueError:
            raise errors.ValidationError("month must be in 'YYYY-MM' format")

        start = date(year, m, 1)
        end = date(year, m, monthrange(year, m)[1])
        period = DateRangeFilter(start_date=start, end_date=end)

        with UnitOfWork(self._session_factory) as uow:
            hostel_repo = self._get_hostel_repo(uow)
            student_repo = self._get_student_repo(uow)
            room_repo = self._get_room_repo(uow)

            hostel = hostel_repo.get(hostel_id)
            if hostel is None:
                raise errors.NotFoundError(f"Hostel {hostel_id} not found")

            students = student_repo.list_for_hostel(hostel_id, status=None)

            room_cache: dict[UUID, str] = {}
            summaries: List[StudentMonthlySummary] = []
            total_pct = Decimal("0")
            meets_count = 0

            for st in students:
                rep = self._analytics.get_student_report(st.id, period)
                s = rep.summary

                if st.room_id and st.room_id not in room_cache:
                    r = room_repo.get(st.room_id)
                    room_cache[st.room_id] = r.room_number if r else ""

                room_number = (
                    room_cache[st.room_id]
                    if getattr(st, "room_id", None) in room_cache
                    else None
                )
                student_name = st.user.full_name if getattr(st, "user", None) else ""

                summaries.append(
                    StudentMonthlySummary(
                        student_id=st.id,
                        student_name=student_name,
                        room_number=room_number,
                        total_days=s.total_days,
                        present_days=s.total_present,
                        absent_days=s.total_absent,
                        late_days=s.total_late,
                        on_leave_days=s.total_on_leave,
                        attendance_percentage=s.attendance_percentage,
                        meets_requirement=s.meets_minimum_requirement,
                        requires_attention=not s.meets_minimum_requirement,
                        action_required=(
                            "Discuss with student/guardian"
                            if not s.meets_minimum_requirement
                            else None
                        ),
                    )
                )

                total_pct += s.attendance_percentage
                if s.meets_minimum_requirement:
                    meets_count += 1

            total_students = len(students)
            hostel_avg = (
                total_pct / Decimal(str(total_students))
                if total_students > 0
                else Decimal("0")
            )
            below_req = total_students - meets_count

            return MonthlyReport(
                hostel_id=hostel_id,
                month=month,
                student_summaries=summaries,
                hostel_average_attendance=hostel_avg,
                total_students=total_students,
                students_meeting_requirement=meets_count,
                students_below_requirement=below_req,
            )

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance\attendance_service.py ---
# app/services/attendance/attendance_service.py
from __future__ import annotations

from datetime import date, datetime
from decimal import Decimal
from typing import Callable, Dict, List, Optional, Sequence
from uuid import UUID

from sqlalchemy.orm import Session

from app.repositories.services import AttendanceRepository
from app.repositories.core import (
    StudentRepository,
    HostelRepository,
    RoomRepository,
    UserRepository,
    SupervisorRepository,
)
from app.schemas.attendance.attendance_base import (
    AttendanceCreate,
    AttendanceUpdate,
)
from app.schemas.attendance.attendance_filters import AttendanceFilterParams
from app.schemas.attendance.attendance_record import (
    AttendanceRecordRequest,
    BulkAttendanceRequest,
)
from app.schemas.attendance.attendance_response import (
    AttendanceResponse,
    AttendanceDetail,
    AttendanceListItem,
    DailyAttendanceSummary,
)
from app.schemas.common.enums import AttendanceStatus, AttendanceMode
from app.schemas.common.pagination import PaginationParams, PaginatedResponse
from app.services.common import UnitOfWork, errors


class AttendanceService:
    """
    Core attendance service:

    - Create/update single attendance records
    - Bulk mark attendance for many students
    - Retrieve attendance detail
    - List attendance with filters
    - Daily hostel summary
    """

    def __init__(self, session_factory: Callable[[], Session]) -> None:
        self._session_factory = session_factory

    # ------------------------------------------------------------------ #
    # Helpers
    # ------------------------------------------------------------------ #
    def _get_repo(self, uow: UnitOfWork) -> AttendanceRepository:
        return uow.get_repo(AttendanceRepository)

    def _get_student_repo(self, uow: UnitOfWork) -> StudentRepository:
        return uow.get_repo(StudentRepository)

    def _get_hostel_repo(self, uow: UnitOfWork) -> HostelRepository:
        return uow.get_repo(HostelRepository)

    def _get_room_repo(self, uow: UnitOfWork) -> RoomRepository:
        return uow.get_repo(RoomRepository)

    def _get_user_repo(self, uow: UnitOfWork) -> UserRepository:
        return uow.get_repo(UserRepository)

    def _get_supervisor_repo(self, uow: UnitOfWork) -> SupervisorRepository:
        return uow.get_repo(SupervisorRepository)

    def _now(self) -> datetime:
        return datetime.utcnow()

    # ------------------------------------------------------------------ #
    # Mapping helpers
    # ------------------------------------------------------------------ #
    def _to_response(
        self,
        a,
        *,
        hostel_name: str,
        student_name: str,
        room_number: Optional[str],
        marked_by_name: str,
    ) -> AttendanceResponse:
        return AttendanceResponse(
            id=a.id,
            created_at=a.created_at,
            updated_at=a.updated_at,
            hostel_id=a.hostel_id,
            hostel_name=hostel_name,
            student_id=a.student_id,
            student_name=student_name,
            room_number=room_number,
            attendance_date=a.attendance_date,
            check_in_time=a.check_in_time,
            check_out_time=a.check_out_time,
            status=a.status,
            is_late=a.is_late,
            late_minutes=a.late_minutes,
            marked_by=a.marked_by_id,
            marked_by_name=marked_by_name,
        )

    def _to_detail(
        self,
        a,
        *,
        hostel_name: str,
        student_name: str,
        student_email: str,
        student_phone: str,
        room_number: Optional[str],
        marked_by_name: str,
        supervisor_name: Optional[str],
    ) -> AttendanceDetail:
        return AttendanceDetail(
            id=a.id,
            created_at=a.created_at,
            updated_at=a.updated_at,
            hostel_id=a.hostel_id,
            hostel_name=hostel_name,
            student_id=a.student_id,
            student_name=student_name,
            student_email=student_email,
            student_phone=student_phone,
            room_number=room_number,
            attendance_date=a.attendance_date,
            check_in_time=a.check_in_time,
            check_out_time=a.check_out_time,
            status=a.status,
            is_late=a.is_late,
            late_minutes=a.late_minutes,
            attendance_mode=a.attendance_mode,
            marked_by=a.marked_by_id,
            marked_by_name=marked_by_name,
            supervisor_id=a.supervisor_id,
            supervisor_name=supervisor_name,
            notes=a.notes,
            location_lat=None,
            location_lng=None,
            device_info=None,
        )

    def _to_list_item(
        self,
        a,
        *,
        student_name: str,
        room_number: Optional[str],
        marked_by_name: str,
    ) -> AttendanceListItem:
        return AttendanceListItem(
            id=a.id,
            student_name=student_name,
            room_number=room_number,
            attendance_date=a.attendance_date,
            status=a.status,
            check_in_time=a.check_in_time,
            is_late=a.is_late,
            marked_by_name=marked_by_name,
        )

    # ------------------------------------------------------------------ #
    # Core read
    # ------------------------------------------------------------------ #
    def get_attendance(self, attendance_id: UUID) -> AttendanceDetail:
        with UnitOfWork(self._session_factory) as uow:
            repo = self._get_repo(uow)
            hostel_repo = self._get_hostel_repo(uow)
            student_repo = self._get_student_repo(uow)
            room_repo = self._get_room_repo(uow)
            user_repo = self._get_user_repo(uow)
            supervisor_repo = self._get_supervisor_repo(uow)

            a = repo.get(attendance_id)
            if a is None:
                raise errors.NotFoundError(f"Attendance {attendance_id} not found")

            hostel = hostel_repo.get(a.hostel_id)
            hostel_name = hostel.name if hostel else ""

            student = student_repo.get(a.student_id)
            if student is None or not getattr(student, "user", None):
                raise errors.NotFoundError(
                    f"Student {a.student_id} not found for attendance"
                )
            student_user = student.user
            student_name = student_user.full_name
            student_email = student_user.email
            student_phone = getattr(student_user, "phone", "")

            room_number: Optional[str] = None
            if student.room_id:
                room = room_repo.get(student.room_id)
                room_number = room.room_number if room else None

            marked_by_user = user_repo.get(a.marked_by_id)
            marked_by_name = marked_by_user.full_name if marked_by_user else ""

            supervisor_name = None
            if a.supervisor_id:
                sup = supervisor_repo.get(a.supervisor_id)
                if sup and getattr(sup, "user", None):
                    supervisor_name = sup.user.full_name

            return self._to_detail(
                a,
                hostel_name=hostel_name,
                student_name=student_name,
                student_email=student_email,
                student_phone=student_phone,
                room_number=room_number,
                marked_by_name=marked_by_name,
                supervisor_name=supervisor_name,
            )

    # ------------------------------------------------------------------ #
    # Listing
    # ------------------------------------------------------------------ #
    def list_attendance(
        self,
        params: PaginationParams,
        filters: Optional[AttendanceFilterParams] = None,
    ) -> PaginatedResponse[AttendanceListItem]:
        """
        Paginated list of attendance records with filters.
        """
        with UnitOfWork(self._session_factory) as uow:
            repo = self._get_repo(uow)
            student_repo = self._get_student_repo(uow)
            room_repo = self._get_room_repo(uow)
            user_repo = self._get_user_repo(uow)

            raw_filters: Dict[str, object] = {}
            if filters:
                if filters.hostel_id:
                    raw_filters["hostel_id"] = filters.hostel_id
                elif filters.hostel_ids:
                    raw_filters["hostel_id"] = filters.hostel_ids
                if filters.student_id:
                    raw_filters["student_id"] = filters.student_id
                elif filters.student_ids:
                    raw_filters["student_id"] = filters.student_ids
                if filters.status:
                    raw_filters["status"] = filters.status
                elif filters.statuses:
                    raw_filters["status"] = filters.statuses
                if filters.marked_by:
                    raw_filters["marked_by_id"] = filters.marked_by
                if filters.supervisor_id:
                    raw_filters["supervisor_id"] = filters.supervisor_id

            records: Sequence = repo.get_multi(
                skip=0,
                limit=None,  # type: ignore[arg-type]
                filters=raw_filters or None,
                order_by=[repo.model.attendance_date.desc()],  # type: ignore[attr-defined]
            )

            # Advanced filters in Python
            def _match(a) -> bool:
                if not filters:
                    return True

                if filters.date_from and a.attendance_date < filters.date_from:
                    return False
                if filters.date_to and a.attendance_date > filters.date_to:
                    return False
                if filters.late_only and not a.is_late:
                    return False
                if filters.attendance_mode and a.attendance_mode.value != filters.attendance_mode:
                    return False
                return True

            filtered = [a for a in records if _match(a)]

            # Room filter requires looking up students
            if filters and filters.room_id:
                room_id = filters.room_id
                student_room_cache: Dict[UUID, Optional[UUID]] = {}
                tmp: List = []
                for a in filtered:
                    sid = a.student_id
                    if sid not in student_room_cache:
                        st = student_repo.get(sid)
                        student_room_cache[sid] = st.room_id if st else None
                    if student_room_cache[sid] == room_id:
                        tmp.append(a)
                filtered = tmp

            total = len(filtered)
            start = params.offset
            end = start + params.limit
            page_items = filtered[start:end]

            # Map to list items
            student_cache: Dict[UUID, object] = {}
            room_cache: Dict[UUID, Optional[str]] = {}
            user_cache: Dict[UUID, str] = {}

            items: List[AttendanceListItem] = []
            for a in page_items:
                # student
                if a.student_id not in student_cache:
                    st = student_repo.get(a.student_id)
                    student_cache[a.student_id] = st
                st = student_cache[a.student_id]
                if st is not None and getattr(st, "user", None):
                    student_name = st.user.full_name
                else:
                    student_name = ""

                # room
                room_number: Optional[str] = None
                if st is not None and getattr(st, "room_id", None):
                    rid = st.room_id
                    if rid not in room_cache:
                        r = room_repo.get(rid)
                        room_cache[rid] = r.room_number if r else None
                    room_number = room_cache[rid]  # type: ignore[name-defined]

                # marked_by
                if a.marked_by_id not in user_cache:
                    u = user_repo.get(a.marked_by_id)
                    user_cache[a.marked_by_id] = u.full_name if u else ""
                marked_by_name = user_cache[a.marked_by_id]

                items.append(
                    self._to_list_item(
                        a,
                        student_name=student_name,
                        room_number=room_number,
                        marked_by_name=marked_by_name,
                    )
                )

            return PaginatedResponse[AttendanceListItem].create(
                items=items,
                total_items=total,
                page=params.page,
                page_size=params.page_size,
            )

    # ------------------------------------------------------------------ #
    # Create / update
    # ------------------------------------------------------------------ #
    def create_attendance(self, data: AttendanceCreate) -> AttendanceDetail:
        """
        Create a new attendance record.
        """
        with UnitOfWork(self._session_factory) as uow:
            repo = self._get_repo(uow)
            hostel_repo = self._get_hostel_repo(uow)
            student_repo = self._get_student_repo(uow)
            user_repo = self._get_user_repo(uow)
            room_repo = self._get_room_repo(uow)
            supervisor_repo = self._get_supervisor_repo(uow)

            hostel = hostel_repo.get(data.hostel_id)
            if hostel is None:
                raise errors.NotFoundError(f"Hostel {data.hostel_id} not found")

            student = student_repo.get(data.student_id)
            if student is None or not getattr(student, "user", None):
                raise errors.NotFoundError(f"Student {data.student_id} not found")
            student_user = student.user

            payload = {
                "hostel_id": data.hostel_id,
                "student_id": data.student_id,
                "attendance_date": data.attendance_date,
                "check_in_time": data.check_in_time,
                "check_out_time": data.check_out_time,
                "status": data.status,
                "is_late": data.is_late,
                "late_minutes": data.late_minutes,
                "attendance_mode": data.attendance_mode,
                "marked_by_id": data.marked_by,
                "supervisor_id": data.supervisor_id,
                "notes": data.notes,
            }
            a = repo.create(payload)  # type: ignore[arg-type]
            uow.commit()

            # Map to detail
            student_name = student_user.full_name
            student_email = student_user.email
            student_phone = getattr(student_user, "phone", "")
            room_number: Optional[str] = None
            if student.room_id:
                room = room_repo.get(student.room_id)
                room_number = room.room_number if room else None

            marked_by_user = user_repo.get(a.marked_by_id)
            marked_by_name = marked_by_user.full_name if marked_by_user else ""

            supervisor_name = None
            if a.supervisor_id:
                sup = supervisor_repo.get(a.supervisor_id)
                if sup and getattr(sup, "user", None):
                    supervisor_name = sup.user.full_name

            return self._to_detail(
                a,
                hostel_name=hostel.name,
                student_name=student_name,
                student_email=student_email,
                student_phone=student_phone,
                room_number=room_number,
                marked_by_name=marked_by_name,
                supervisor_name=supervisor_name,
            )

    def record_attendance(
        self,
        req: AttendanceRecordRequest,
        *,
        marked_by: UUID,
        supervisor_id: Optional[UUID] = None,
        mode: AttendanceMode = AttendanceMode.MANUAL,
    ) -> AttendanceDetail:
        """
        Convenience wrapper to create attendance from AttendanceRecordRequest.
        """
        data = AttendanceCreate(
            hostel_id=req.hostel_id,
            student_id=req.student_id,
            attendance_date=req.attendance_date,
            check_in_time=req.check_in_time,
            check_out_time=req.check_out_time,
            status=req.status,
            is_late=req.is_late,
            late_minutes=None,
            attendance_mode=mode,
            marked_by=marked_by,
            supervisor_id=supervisor_id,
            notes=req.notes,
            location_lat=None,
            location_lng=None,
            device_info=None,
        )
        return self.create_attendance(data)

    def bulk_record_attendance(self, req: BulkAttendanceRequest) -> int:
        """
        Bulk mark attendance for many students.

        - If a record for (hostel_id, student_id, date) exists, it is updated.
        - Otherwise, a new record is created.
        """
        count = 0
        with UnitOfWork(self._session_factory) as uow:
            repo = self._get_repo(uow)

            for rec in req.student_records:
                status = rec.status or req.default_status
                existing = repo.get_multi(
                    skip=0,
                    limit=1,
                    filters={
                        "hostel_id": req.hostel_id,
                        "student_id": rec.student_id,
                        "attendance_date": req.attendance_date,
                    },
                )
                if existing:
                    a = existing[0]
                    a.status = status  # type: ignore[attr-defined]
                    a.check_in_time = rec.check_in_time  # type: ignore[attr-defined]
                    a.is_late = rec.is_late if rec.is_late is not None else a.is_late  # type: ignore[attr-defined]
                    a.marked_by_id = req.marked_by  # type: ignore[attr-defined]
                    uow.session.flush()  # type: ignore[union-attr]
                else:
                    payload = {
                        "hostel_id": req.hostel_id,
                        "student_id": rec.student_id,
                        "attendance_date": req.attendance_date,
                        "check_in_time": rec.check_in_time,
                        "check_out_time": None,
                        "status": status,
                        "is_late": rec.is_late or False,
                        "late_minutes": None,
                        "attendance_mode": AttendanceMode.MANUAL,
                        "marked_by_id": req.marked_by,
                        "supervisor_id": None,
                        "notes": rec.notes,
                    }
                    repo.create(payload)  # type: ignore[arg-type]
                count += 1

            uow.commit()
        return count

    def update_attendance(
        self,
        attendance_id: UUID,
        data: AttendanceUpdate,
    ) -> AttendanceDetail:
        """
        Update an existing attendance record.
        """
        with UnitOfWork(self._session_factory) as uow:
            repo = self._get_repo(uow)

            a = repo.get(attendance_id)
            if a is None:
                raise errors.NotFoundError(f"Attendance {attendance_id} not found")

            mapping = data.model_dump(exclude_unset=True)
            for field, value in mapping.items():
                if hasattr(a, field) and field != "id":
                    setattr(a, field, value)

            uow.session.flush()  # type: ignore[union-attr]
            uow.commit()
        return self.get_attendance(attendance_id)

    # ------------------------------------------------------------------ #
    # Daily summary
    # ------------------------------------------------------------------ #
    def get_daily_summary(self, hostel_id: UUID, day: date) -> DailyAttendanceSummary:
        with UnitOfWork(self._session_factory) as uow:
            repo = self._get_repo(uow)
            hostel_repo = self._get_hostel_repo(uow)
            student_repo = self._get_student_repo(uow)
            user_repo = self._get_user_repo(uow)

            hostel = hostel_repo.get(hostel_id)
            if hostel is None:
                raise errors.NotFoundError(f"Hostel {hostel_id} not found")

            students = student_repo.list_for_hostel(hostel_id, status=None)
            total_students = len(students)

            records = repo.list_for_hostel_date(hostel_id, day)

            total_present = total_absent = total_late = total_on_leave = 0
            for a in records:
                if a.status == AttendanceStatus.PRESENT:
                    total_present += 1
                elif a.status == AttendanceStatus.ABSENT:
                    total_absent += 1
                elif a.status == AttendanceStatus.LATE:
                    total_late += 1
                    total_present += 1  # count as present
                elif a.status == AttendanceStatus.ON_LEAVE:
                    total_on_leave += 1

            attendance_percentage = (
                Decimal(str(total_present))
                / Decimal(str(total_students or 1))
                * 100
                if total_students > 0
                else Decimal("0")
            )

            # Pick one "marked_by" as representative
            marked_by_id: Optional[UUID] = None
            marked_at: Optional[datetime] = None
            if records:
                first = records[0]
                marked_by_id = first.marked_by_id
                marked_at = first.created_at

            marked_by_name = ""
            if marked_by_id:
                u = user_repo.get(marked_by_id)
                marked_by_name = u.full_name if u else ""

            marking_completed = total_students > 0 and len(records) >= total_students

            return DailyAttendanceSummary(
                hostel_id=hostel_id,
                hostel_name=hostel.name,
                date=day,
                total_students=total_students,
                total_present=total_present,
                total_absent=total_absent,
                total_late=total_late,
                total_on_leave=total_on_leave,
                attendance_percentage=attendance_percentage,
                marked_by=marked_by_id or UUID(int=0),
                marked_by_name=marked_by_name,
                marking_completed=marking_completed,
                marked_at=marked_at,
            )

# --- File: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance\__init__.py ---
# app/services/attendance/__init__.py
"""
Attendance-related services.

- AttendanceService: core attendance CRUD, listing, daily summary.
- AttendanceAlertService: alert configuration and alert lifecycle.
- AttendancePolicyService: attendance policy configuration and violation checks.
- AttendanceReportService: higher-level reports (student, monthly hostel).
"""

from .attendance_service import AttendanceService
from .attendance_alert_service import AttendanceAlertService, AlertStore
from .attendance_policy_service import AttendancePolicyService, PolicyStore
from .attendance_report_service import AttendanceReportService

__all__ = [
    "AttendanceService",
    "AttendanceAlertService",
    "AlertStore",
    "AttendancePolicyService",
    "PolicyStore",
    "AttendanceReportService",
]


# ===== Folder: C:\Users\HP\OneDrive\Documents\GitHub\HOStel-back\app\services\attendance\__pycache__ =====
