### Combined Content from Folder: D:\Last Github Push\Last\HOStel-back\app\core ###



# ===== Folder: D:\Last Github Push\Last\HOStel-back\app\core =====

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\constants.py ---
# app/core/constants.py
from __future__ import annotations

from datetime import timedelta

# Pagination defaults
DEFAULT_PAGE: int = 1
DEFAULT_PAGE_SIZE: int = 20
MAX_PAGE_SIZE: int = 100

# JWT defaults (used if not overridden by settings)
ACCESS_TOKEN_EXPIRE_MINUTES_DEFAULT: int = 60
REFRESH_TOKEN_EXPIRE_DAYS_DEFAULT: int = 30

# API prefixes
API_PREFIX: str = "/api"
API_V1_PREFIX: str = "/api/v1"

# Common HTTP header names
HEADER_REQUEST_ID: str = "X-Request-ID"
HEADER_USER_ID: str = "X-User-ID"
HEADER_CORRELATION_ID: str = "X-Correlation-ID"

# Environment keys (optional; align with your settings)
ENV_DATABASE_URL: str = "DATABASE_URL"
ENV_JWT_SECRET_KEY: str = "JWT_SECRET_KEY"

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\database.py ---
# app/core/database.py
from __future__ import annotations

import os
from contextlib import contextmanager
from typing import Iterator, Generator

from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker

from app.core.constants import ENV_DATABASE_URL
from app.models.base import Base


# ------------------------------------------------------------------ #
# Engine & Session
# ------------------------------------------------------------------ #
DATABASE_URL = os.getenv(ENV_DATABASE_URL, "sqlite:///./app.db")

engine = create_engine(
    DATABASE_URL,
    future=True,
    echo=False,          # set True for SQL echo in development
)

SessionLocal = sessionmaker(
    bind=engine,
    autoflush=False,
    autocommit=False,
    expire_on_commit=False,
    class_=Session,
)


def get_session() -> Generator[Session, None, None]:
    """
    FastAPI-friendly dependency for DB session:

        def get_db():
            db = SessionLocal()
            try:
                yield db
            finally:
                db.close()

    Here we export get_session directly.
    """
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@contextmanager
def session_scope() -> Iterator[Session]:
    """
    Context manager for scripts / CLIs / background tasks:

        with session_scope() as session:
            ...

    Commits on success, rollbacks on error.
    """
    session: Session = SessionLocal()
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()


def init_db() -> None:
    """
    Simple helper to create all tables.

    In production, prefer Alembic migrations instead of this.
    """
    Base.metadata.create_all(bind=engine)

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\exceptions.py ---
# app/core/exceptions.py
from __future__ import annotations

"""
Core application-level exceptions.

These are thin wrappers / aliases around the service-layer exceptions
defined in `app.services.common.errors` so the rest of the app can
import from a single, central place if desired.
"""

from app.services.common import errors as _errors


# Base application error
AppError = _errors.ServiceError
ServiceError = _errors.ServiceError

# Common specializations
NotFoundError = _errors.NotFoundError
ValidationError = _errors.ValidationError
ConflictError = _errors.ConflictError

__all__ = [
    "AppError",
    "ServiceError",
    "NotFoundError",
    "ValidationError",
    "ConflictError",
]

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\middleware.py ---
# app/core/middleware.py
from __future__ import annotations

import time
import uuid
from typing import Callable

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from starlette.responses import Response

from app.core.constants import HEADER_REQUEST_ID


def register_cors_middleware(app: FastAPI, allow_origins: list[str] | None = None) -> None:
    """
    Register CORS middleware.

    Adjust `allow_origins` for production.
    """
    app.add_middleware(
        CORSMiddleware,
        allow_origins=allow_origins or ["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )


def register_request_id_middleware(app: FastAPI) -> None:
    """
    Simple middleware to inject a request ID into headers for tracing.
    """

    @app.middleware("http")
    async def add_request_id_header(request: Request, call_next: Callable) -> Response:
        request_id = request.headers.get(HEADER_REQUEST_ID) or str(uuid.uuid4())
        request.state.request_id = request_id

        response: Response = await call_next(request)
        response.headers[HEADER_REQUEST_ID] = request_id
        return response


def register_timing_middleware(app: FastAPI) -> None:
    """
    Add X-Process-Time header with request processing time in seconds.
    """

    @app.middleware("http")
    async def add_timing_header(request: Request, call_next: Callable) -> Response:
        start = time.perf_counter()
        response: Response = await call_next(request)
        duration = time.perf_counter() - start
        response.headers["X-Process-Time"] = f"{duration:.4f}"
        return response


def register_middlewares(app: FastAPI) -> None:
    """
    Convenience function to register all core middlewares.
    """
    register_cors_middleware(app)
    register_request_id_middleware(app)
    register_timing_middleware(app)

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\pagination.py ---
# app/core/pagination.py
from __future__ import annotations

from typing import Sequence, Callable, TypeVar, List

from app.core.constants import DEFAULT_PAGE, DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE
from app.schemas.common.pagination import PaginationParams, PaginatedResponse
from app.schemas.common.base import BaseSchema

TModel = TypeVar("TModel")
TSchema = TypeVar("TSchema", bound=BaseSchema)


def normalize_pagination(
    page: int | None,
    page_size: int | None,
) -> PaginationParams:
    """
    Normalize raw page & page_size inputs into a PaginationParams object
    with sane defaults and clamped max page size.
    """
    if page is None or page < 1:
        page = DEFAULT_PAGE

    if page_size is None or page_size < 1:
        page_size = DEFAULT_PAGE_SIZE

    if page_size > MAX_PAGE_SIZE:
        page_size = MAX_PAGE_SIZE

    return PaginationParams(page=page, page_size=page_size)


def paginate_items(
    *,
    items: Sequence[TModel],
    total_items: int,
    params: PaginationParams,
    mapper: Callable[[TModel], TSchema],
) -> PaginatedResponse[TSchema]:
    """
    Map and wrap items into a PaginatedResponse using the same semantics
    as app.services.common.pagination, but exposed from core.
    """
    mapped: List[TSchema] = [mapper(obj) for obj in items]
    return PaginatedResponse[TSchema].create(
        items=mapped,
        total_items=total_items,
        page=params.page,
        page_size=params.page_size,
    )

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\permissions.py ---
# app/core/permissions.py
from __future__ import annotations

"""
Core permission helpers.

These re-export the RBAC helpers from app.services.common.permissions
so they can be imported from a core location.
"""

from app.services.common.permissions import (
    Principal,
    PermissionDenied,
    role_in,
    has_permission,
    require_permission,
)

__all__ = [
    "Principal",
    "PermissionDenied",
    "role_in",
    "has_permission",
    "require_permission",
]

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\security.py ---
# app/core/security.py
from __future__ import annotations

"""
Core security helpers.

These re-export password hashing and JWT helpers from
app.services.common.security so you can import them
from a single core module if needed.
"""

from app.services.common.security import (
    JWTSettings,
    TokenDecodeError,
    hash_password,
    verify_password,
    create_access_token,
    create_refresh_token,
    decode_token,
)

__all__ = [
    "JWTSettings",
    "TokenDecodeError",
    "hash_password",
    "verify_password",
    "create_access_token",
    "create_refresh_token",
    "decode_token",
]

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\__init__.py ---
# app/core/__init__.py
from __future__ import annotations

"""
Core infrastructure exports.

This module re-exports frequently used core utilities to
simplify imports across the project.
"""

from .constants import (
    DEFAULT_PAGE,
    DEFAULT_PAGE_SIZE,
    MAX_PAGE_SIZE,
    API_PREFIX,
    API_V1_PREFIX,
)
from .database import (
    engine,
    SessionLocal,
    get_session,
    session_scope,
    init_db,
)
from .exceptions import (
    AppError,
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from . import security
from . import permissions
from . import pagination
from . import middleware

__all__ = [
    # constants
    "DEFAULT_PAGE",
    "DEFAULT_PAGE_SIZE",
    "MAX_PAGE_SIZE",
    "API_PREFIX",
    "API_V1_PREFIX",
    # db
    "engine",
    "SessionLocal",
    "get_session",
    "session_scope",
    "init_db",
    # exceptions
    "AppError",
    "ServiceError",
    "NotFoundError",
    "ValidationError",
    "ConflictError",
    # submodules
    "security",
    "permissions",
    "pagination",
    "middleware",
]
