### Combined Content from Folder: D:\Last Github Push\Last\HOStel-back\app\core ###



# ===== Folder: D:\Last Github Push\Last\HOStel-back\app\core =====

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\constants.py ---
# app/core/constants.py
from __future__ import annotations

"""
Core application constants.

These values centralize common configuration-like constants such as:
- Pagination defaults.
- JWT token lifetimes (defaults, can be overridden by settings).
- API prefixes.
- Common HTTP header names.
- Environment variable keys.

Note:
    These constants are intended to be imported and used throughout the
    application rather than hard-coding literals in multiple places.
"""

from datetime import timedelta  # Note: imported for potential external usage

# Pagination defaults
DEFAULT_PAGE: int = 1
DEFAULT_PAGE_SIZE: int = 20
MAX_PAGE_SIZE: int = 100

# JWT defaults (used if not overridden by settings)
ACCESS_TOKEN_EXPIRE_MINUTES_DEFAULT: int = 60
REFRESH_TOKEN_EXPIRE_DAYS_DEFAULT: int = 30

# API prefixes
API_PREFIX: str = "/api"
API_V1_PREFIX: str = "/api/v1"

# Common HTTP header names
HEADER_REQUEST_ID: str = "X-Request-ID"
HEADER_USER_ID: str = "X-User-ID"
HEADER_CORRELATION_ID: str = "X-Correlation-ID"

# Environment keys (optional; align with your settings)
ENV_DATABASE_URL: str = "DATABASE_URL"
ENV_JWT_SECRET_KEY: str = "JWT_SECRET_KEY"

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\database.py ---
# app/core/database.py
from __future__ import annotations

"""
Database engine and session management.

This module defines:
- The global SQLAlchemy engine.
- A configured SessionLocal factory.
- Helpers for obtaining/using sessions with FastAPI and scripts.

Notes:
    - DATABASE_URL is read from the environment (ENV_DATABASE_URL) with
      a sensible default (`sqlite:///./app.db`).
    - In production, you should use Alembic migrations instead of `init_db()`.
"""

import os
from contextlib import contextmanager
from typing import Iterator, Generator

from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker

from app.core.constants import ENV_DATABASE_URL
from app.models.base import Base


# ------------------------------------------------------------------ #
# Engine & Session
# ------------------------------------------------------------------ #
DATABASE_URL = os.getenv(ENV_DATABASE_URL, "postgresql://postgresql:Kiran$123@localhost/HostelDb")

engine = create_engine(
    DATABASE_URL,
    future=True,
    echo=False,          # set True for SQL echo in development
)

SessionLocal = sessionmaker(
    bind=engine,
    autoflush=False,
    autocommit=False,
    expire_on_commit=False,
    class_=Session,
)


def get_session() -> Generator[Session, None, None]:
    """
    FastAPI-friendly dependency for a DB session.

    Example integration:

        def get_db():
            db = SessionLocal()
            try:
                yield db
            finally:
                db.close()

    Here we export get_session directly so application code can do:

        from app.core import get_session
    """
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@contextmanager
def session_scope() -> Iterator[Session]:
    """
    Context manager for scripts / CLIs / background tasks.

    Usage:

        from app.core import session_scope

        with session_scope() as session:
            # use session
            ...

    This commits on success, and rolls back on any exception.
    """
    session: Session = SessionLocal()
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()


def init_db() -> None:
    """
    Simple helper to create all tables from SQLAlchemy models.

    In production, prefer Alembic migrations instead of calling this
    directly, to ensure schema changes are managed and versioned.
    """
    Base.metadata.create_all(bind=engine)

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\exceptions.py ---
# app/core/exceptions.py
from __future__ import annotations

"""
Core application-level exceptions.

These are thin wrappers / aliases around the service-layer exceptions
defined in `app.services.common.errors`, allowing the rest of the app
to import exception types from a single, central place:

    from app.core import AppError, NotFoundError, ValidationError
"""

from app.services.common import errors as _errors


# Base application error
AppError = _errors.ServiceError
ServiceError = _errors.ServiceError

# Common specializations
NotFoundError = _errors.NotFoundError
ValidationError = _errors.ValidationError
ConflictError = _errors.ConflictError

__all__ = [
    "AppError",
    "ServiceError",
    "NotFoundError",
    "ValidationError",
    "ConflictError",
]

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\middleware.py ---
# app/core/middleware.py
from __future__ import annotations

"""
Core FastAPI middleware registration helpers.

This module defines small helpers to register:
- CORS middleware.
- Request ID correlation middleware.
- Simple timing middleware.

These can be composed via `register_middlewares` to keep your app
startup code clean and consistent.
"""

import time
import uuid
from typing import Callable

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from starlette.responses import Response

from app.core.constants import HEADER_REQUEST_ID


def register_cors_middleware(app: FastAPI, allow_origins: list[str] | None = None) -> None:
    """
    Register CORS middleware on the given FastAPI app.

    Args:
        app: FastAPI application instance.
        allow_origins: List of origins to allow. Defaults to ["*"] for
                       convenience; this should be tightened in production.
    """
    app.add_middleware(
        CORSMiddleware,
        allow_origins=allow_origins or ["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )


def register_request_id_middleware(app: FastAPI) -> None:
    """
    Register middleware to inject a request ID into the request state
    and response headers for tracing and correlation.

    - If the incoming request already has HEADER_REQUEST_ID, it is reused.
    - Otherwise a new UUID4 is generated.
    """

    @app.middleware("http")
    async def add_request_id_header(request: Request, call_next: Callable) -> Response:
        request_id = request.headers.get(HEADER_REQUEST_ID) or str(uuid.uuid4())
        request.state.request_id = request_id

        response: Response = await call_next(request)
        response.headers[HEADER_REQUEST_ID] = request_id
        return response


def register_timing_middleware(app: FastAPI) -> None:
    """
    Register middleware to add an X-Process-Time header with the request
    processing time in seconds (as a float formatted to 4 decimal places).
    """

    @app.middleware("http")
    async def add_timing_header(request: Request, call_next: Callable) -> Response:
        start = time.perf_counter()
        response: Response = await call_next(request)
        duration = time.perf_counter() - start
        response.headers["X-Process-Time"] = f"{duration:.4f}"
        return response


def register_middlewares(app: FastAPI) -> None:
    """
    Convenience function to register all core middlewares at once.

    Currently includes:
    - CORS middleware.
    - Request ID middleware.
    - Timing middleware.
    """
    register_cors_middleware(app)
    register_request_id_middleware(app)
    register_timing_middleware(app)

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\pagination.py ---
# app/core/pagination.py
from __future__ import annotations

"""
Core pagination helpers.

This module provides:
- `normalize_pagination` to clean up page/page_size inputs using defaults
  and clamping.
- `paginate_items` to map and wrap results in a `PaginatedResponse` schema.

These helpers unify pagination semantics across the project.
"""

from typing import Sequence, Callable, TypeVar, List

from app.core.constants import DEFAULT_PAGE, DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE
from app.schemas.common.pagination import PaginationParams, PaginatedResponse
from app.schemas.common.base import BaseSchema

TModel = TypeVar("TModel")
TSchema = TypeVar("TSchema", bound=BaseSchema)


def normalize_pagination(
    page: int | None,
    page_size: int | None,
) -> PaginationParams:
    """
    Normalize raw page & page_size inputs into a PaginationParams object
    with sane defaults and a clamped max page size.

    Rules:
        - page < 1 or None -> DEFAULT_PAGE
        - page_size < 1 or None -> DEFAULT_PAGE_SIZE
        - page_size > MAX_PAGE_SIZE -> MAX_PAGE_SIZE
    """
    if page is None or page < 1:
        page = DEFAULT_PAGE

    if page_size is None or page_size < 1:
        page_size = DEFAULT_PAGE_SIZE

    if page_size > MAX_PAGE_SIZE:
        page_size = MAX_PAGE_SIZE

    return PaginationParams(page=page, page_size=page_size)


def paginate_items(
    *,
    items: Sequence[TModel],
    total_items: int,
    params: PaginationParams,
    mapper: Callable[[TModel], TSchema],
) -> PaginatedResponse[TSchema]:
    """
    Map and wrap items into a PaginatedResponse using the same semantics
    as app.services.common.pagination, but exposed from core.

    Args:
        items: Sequence of model instances (DB objects, domain objects, etc.).
        total_items: Total number of items across all pages (for metadata).
        params: Pagination parameters (page, page_size).
        mapper: Function to convert each model instance into a schema instance.

    Returns:
        A `PaginatedResponse[TSchema]` populated with mapped items and metadata.
    """
    mapped: List[TSchema] = [mapper(obj) for obj in items]
    return PaginatedResponse[TSchema].create(
        items=mapped,
        total_items=total_items,
        page=params.page,
        page_size=params.page_size,
    )

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\permissions.py ---
# app/core/permissions.py
from __future__ import annotations

"""
Core permission helpers.

These re-export the RBAC helpers from `app.services.common.permissions`
so they can be imported from a core location, e.g.:

    from app.core.permissions import has_permission, require_permission

This keeps import paths in application code shorter and more consistent.
"""

from app.services.common.permissions import (
    Principal,
    PermissionDenied,
    role_in,
    has_permission,
    require_permission,
)

__all__ = [
    "Principal",
    "PermissionDenied",
    "role_in",
    "has_permission",
    "require_permission",
]

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\security.py ---
# app/core/security.py
from __future__ import annotations

"""
Core security helpers.

These re-export password hashing and JWT helpers from
`app.services.common.security` so you can import them
from a single core module if needed, for example:

    from app.core.security import hash_password, create_access_token
"""

from app.services.common.security import (
    JWTSettings,
    TokenDecodeError,
    hash_password,
    verify_password,
    create_access_token,
    create_refresh_token,
    decode_token,
)

__all__ = [
    "JWTSettings",
    "TokenDecodeError",
    "hash_password",
    "verify_password",
    "create_access_token",
    "create_refresh_token",
    "decode_token",
]

# --- File: D:\Last Github Push\Last\HOStel-back\app\core\__init__.py ---
# app/core/__init__.py
from __future__ import annotations

"""
Core infrastructure exports.

This module re-exports frequently used core utilities to
simplify imports across the project, allowing patterns like:

    from app.core import (
        DEFAULT_PAGE,
        engine,
        get_session,
        AppError,
        security,
    )
"""

from .constants import (
    DEFAULT_PAGE,
    DEFAULT_PAGE_SIZE,
    MAX_PAGE_SIZE,
    API_PREFIX,
    API_V1_PREFIX,
)
from .database import (
    engine,
    SessionLocal,
    get_session,
    session_scope,
    init_db,
)
from .exceptions import (
    AppError,
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from . import security
from . import permissions
from . import pagination
from . import middleware

__all__ = [
    # constants
    "DEFAULT_PAGE",
    "DEFAULT_PAGE_SIZE",
    "MAX_PAGE_SIZE",
    "API_PREFIX",
    "API_V1_PREFIX",
    # db
    "engine",
    "SessionLocal",
    "get_session",
    "session_scope",
    "init_db",
    # exceptions
    "AppError",
    "ServiceError",
    "NotFoundError",
    "ValidationError",
    "ConflictError",
    # submodules
    "security",
    "permissions",
    "pagination",
    "middleware",
]


# ===== Folder: D:\Last Github Push\Last\HOStel-back\app\core\__pycache__ =====
